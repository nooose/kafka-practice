# 카프카 핵심 가이드

카프카 핵심 가이드 내용을 스프링부트 애플리케이션과 함께 실습할 수 있다.

# 프로듀서

## 프로듀서 옵션(`spring.kafka.producer`)
- `acks`
  - `0`: 브로커의 응답을 기다리지 않는다.
  - `1`: 리더 레플리카 메시지를 받는 순간 브로커로부터 성공했다는 응답을 받는다.
  - `-1(all)`: 인 싱크 레플리카에 전달된 뒤에야 브로커로부터 성공했다는 응답을 받는다.

  - `properties`
    - `max.in.flight.requests.per.connection`: 서버로 부터 응답을 받지 못한 상태에서 전송할 수 있는 최대 메시지의 수
    - `retries`: 재전송하는 횟수
    - `enable.idempotence`: 멱등적 프로듀서, 레코드를 보낼 때 마다 순차적인 번호를 붙여서 보낸다. 만약 동일한 번호를 가진 레코드를 2개 이상 받을 경우 하나만 저장한다.
      - 아래 옵션을 만족해야한다.
      - `acks`: all 
      - `max.in.flight.per.connection` 5 이하
      - `retries` 1 이상

# 컨슈머
## 리밸런스
컨슈머에 할당된 파티션을 다른 컨슈머에게 할당해주는 작업을 말한다.
- eager rebalance: 모든 컨슈머는 읽기 작업을 멈추고, 파티션에 대한 소유권을 포기한 뒤, 다시 참여하여 새로운 파티션을 할당받는다.
- cooperative(incremental) rebalance: 컨슈머 그룹 리더가 파티션 재할당을 통보하면, 해당 파티션에 대한 소유권을 포기한다. 그 이후 컨슈머 그룹 리더가 포기된 파티션들을 새로 할당한다. 

컨슈터 그룹의 `그룹 코디네이터` 역할을 지정받은 카프카 브로커에 `하트비트`를 전송하여 소유권을 유지한다.

이 과정에서 일정 시간 이상 하트비트를 전송하지 않는다면, 세션 타임아웃이 발생하면서 리밸런스를 실행한다.

> `그룹 코디네이터`는 그룹 내 각 멤버에 대한 파티션 할당을 캐시해 두고 있어, 정적 멤버가 다시 조인해 들어온다고 해서 리밸런스를 발생시키지 않는다.
>
> 정적 멤버가 종료되었음을 알아차리는 것은 `session.timeout.ms` 설정에 달려있다.

## 컨슈머 옵션(`spring.kafka.consumer`)
